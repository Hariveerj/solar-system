pipeline {
    agent { label 'app-server-agent' }

    parameters {
        string(name: 'IMAGE_TAG', description: 'Docker image tag to deploy')
    }

    options {
        disableConcurrentBuilds()
        timeout(time: 30, unit: 'MINUTES')
    }

    stages {

        stage('Approval (Phase-3)') {
            steps {
                input message: "Approve deployment of hariveer/solar-system:${params.IMAGE_TAG} to Kubernetes?",
                      ok: "APPROVE"
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                sh '''
                kubectl get deployment solar-system || \
                  kubectl apply -f k8s/solar-deployment.yaml

                kubectl set image deployment/solar-system \
                  solar-system=hariveer/solar-system:${IMAGE_TAG}

                kubectl rollout status deployment/solar-system
                '''
            }
        }
    }
}