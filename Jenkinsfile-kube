pipeline {
  agent { label 'app-server-agent' }

  environment {
    IMAGE_NAME = "hariveer/solar-system"
    IMAGE_TAG  = "${BUILD_NUMBER}"

    // âœ… Correct Kubernetes directory
    K8S_DIR = "k8/development"
  }

  stages {

    stage('Checkout Source') {
      steps {
        checkout scm
      }
    }

    stage('Approval (Phase-3)') {
      steps {
        input message: "Deploy ${IMAGE_NAME}:${IMAGE_TAG} to Kubernetes?",
              ok: "APPROVE"
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        sh '''
        echo "ğŸ”¹ Kubernetes files location:"
        ls -R ${K8S_DIR}

        echo "ğŸ”¹ Applying Deployment"
        kubectl apply -f ${K8S_DIR}/deployment.yaml

        echo "ğŸ”¹ Applying Service"
        kubectl apply -f ${K8S_DIR}/service.yaml

        echo "ğŸ”¹ Applying Ingress"
        kubectl apply -f ${K8S_DIR}/ingress.yaml

        echo "ğŸ”¹ Waiting for rollout"
        kubectl rollout status deployment/solar-system -n default
        '''
      }
    }
  }

  post {
    success {
      echo "âœ… Phase-3 Kubernetes Deployment Successful"
    }
    failure {
      echo "âŒ Phase-3 Kubernetes Deployment Failed"
    }
  }
}