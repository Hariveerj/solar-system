pipeline {
    agent { label 'app-server-agent' }

    environment {
        IMAGE_NAME = 'hariveer/solar-system'
        IMAGE_TAG  = "${BUILD_NUMBER}"
        K8S_PATH   = 'k8/development'
    }

    stages {

        stage('Checkout Source') {
            steps {
                checkout scm
            }
        }

        stage('Approval (Phase-3)') {
            steps {
                input message: "Approve deployment of ${IMAGE_NAME}:${IMAGE_TAG} to Kubernetes?",
                      ok: "Deploy"
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                sh '''
                echo "üîπ Updating image tag in deployment file"

                sed -i "s|image:.*|image: ${IMAGE_NAME}:${IMAGE_TAG}|" ${K8S_PATH}/deployment.yaml

                echo "üîπ Applying Kubernetes manifests"
                kubectl apply -f ${K8S_PATH}/deployment.yaml
                kubectl apply -f ${K8S_PATH}/service.yaml
                kubectl apply -f ${K8S_PATH}/ingress.yaml
                '''
            }
        }

        stage('Verify Deployment') {
            steps {
                sh '''
                echo "üîπ Pods"
                kubectl get pods -l app=solar-system

                echo "üîπ Service"
                kubectl get svc solar-system

                echo "üîπ Ingress"
                kubectl get ingress solar-system
                '''
            }
        }
    }

    post {
        success {
            echo '‚úÖ Phase-3 completed: Application deployed to Kubernetes'
        }
        failure {
            echo '‚ùå Phase-3 failed: Check kubectl logs'
        }
    }
}