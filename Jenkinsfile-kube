pipeline {
  agent { label 'app-server-agent' }

  environment {
    IMAGE_NAME = "hariveer/solar-system"
    IMAGE_TAG  = "${BUILD_NUMBER}"
    K8S_DIR    = "/opt/jenkins-agent/workdir/workspace/solar-system-deploy/k8/development"
  }

  stages {

    stage('Checkout Source') {
      steps {
        checkout scm
      }
    }

    stage('Approval (Phase-3)') {
      steps {
        input message: "Deploy ${IMAGE_NAME}:${IMAGE_TAG} to Kubernetes?",
              ok: "APPROVE"
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        sh '''
        echo "üîπ Applying Kubernetes manifests"

        kubectl apply -f ${K8S_DIR}/deployment.yaml
        kubectl apply -f ${K8S_DIR}/service.yaml
        kubectl apply -f ${K8S_DIR}/ingress.yaml

        echo "üîπ Waiting for deployment rollout"
        kubectl rollout status deployment/solar-system
        '''
      }
    }
  }

  post {
    success {
      echo "‚úÖ Phase-3 Deployment Successful"
    }
    failure {
      echo "‚ùå Phase-3 Deployment Failed"
    }
  }
}